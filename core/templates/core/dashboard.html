{% extends "core/base.html" %}

{% block page_content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Panel de Control</h2>
        <a href="{% url 'upload_document' %}" class="btn btn-primary">
            <i class="bi bi-file-earmark-plus"></i> Subir Documento
        </a>
    </div>

    {% if documents %}
        <div class="list-group">
            {% for document in documents %}
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">{{ document.title }}</h5>
                        <small class="text-muted">Estado: <strong>{{ document.get_status_display }}</strong> | Subido: {{ document.created_at|date:"d M Y, P" }}</small>
                    </div>
                    <div>
    
                        {% if document.status == 'flattened' %}
                            <a href="{{ document.signed_file.url }}" class="btn btn-sm btn-success" download>
                                <i class="bi bi-download"></i> Descargar Firmado
                            </a>
                        {% elif document.status == 'signed' %}
                            <a href="{{ document.signed_file.url }}" class="btn btn-sm btn-success" download>
                                <i class="bi bi-download"></i> Descargar Firmado
                            </a>

                            {% comment %} <button class="btn btn-sm btn-primary btn-rasterizar" data-document-id="{{ document.pk }}">
                                <i class="bi bi-pass-fill"></i> Aplanar
                            </button> {% endcomment %}
                        {% elif document.status == 'uploaded' %}
                            <a href="{% url 'sign_document_editor' pk=document.pk %}" class="btn btn-sm btn-secondary">
                                <i class="bi bi-pencil-fill"></i> Firmar
                            </a>
                            <button class="btn btn-sm btn-primary btn-flatten-original" data-document-id="{{ document.pk }}">
                                <i class="bi bi-pass-fill"></i> Aplanar Original
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        {% endif %}

    <div id="statusMessage" class="mt-3"></div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrftoken = getCookie('csrftoken');

        // --- Lógica para el botón de Rasterizar (documento firmado) ---
        const rasterizeButtons = document.querySelectorAll('.btn-rasterizar');
        rasterizeButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); 
                const documentId = this.dataset.documentId;
                // La URL usa ` para que ${documentId} se interprete correctamente
                handleDocumentAction(this, documentId, `/api/documents/${documentId}/rasterize/`, 'Aplanado/Rasterizado', 'Descargar Aplanado', 'btn-success');
            });
        });

        // --- Lógica para el botón de Aplanar Original (documento subido) ---
        const flattenOriginalButtons = document.querySelectorAll('.btn-flatten-original');
        flattenOriginalButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); 
                const documentId = this.dataset.documentId;
                // La URL usa ` para que ${documentId} se interprete correctamente
                handleDocumentAction(this, documentId, `/api/documents/${documentId}/flatten_original/`, 'Original Aplanado', 'Descargar Original Aplanado', 'btn-info');
            });
        });

        /**
         * Función genérica para manejar las acciones del documento (rasterizar/aplanar).
         * @param {HTMLElement} button - El botón que se hizo clic.
         * @param {string} documentId - El ID del documento.
         * @param {string} apiUrl - La URL de la API a la que se va a llamar.
         * @param {string} newStatusText - El nuevo texto de estado para mostrar.
         * @param {string} newButtonText - El nuevo texto para el botón de descarga.
         * @param {string} newButtonClass - La nueva clase CSS del botón.
         */
        function handleDocumentAction(button, documentId, apiUrl, newStatusText, newButtonText, newButtonClass) {
            const listItem = button.closest('.list-group-item');
            const statusElement = listItem.querySelector('small strong');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
            button.disabled = true;

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Error desconocido.');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Crea y configura el nuevo enlace de descarga
                    const downloadLink = document.createElement('a');
                    downloadLink.href = data.download_url;
                    downloadLink.className = `btn btn-sm ${newButtonClass}`;
                    downloadLink.download = true;
                    downloadLink.innerHTML = `<i class="bi bi-download"></i> ${newButtonText}`;
                    
                    button.replaceWith(downloadLink);

                    if (statusElement) {
                        statusElement.innerText = newStatusText;
                    }
                    
                    const statusMessage = document.getElementById('statusMessage');
                    statusMessage.innerHTML = `<div class="alert alert-success" role="alert">Documento '${documentId}' procesado exitosamente.</div>`;
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                button.innerHTML = originalText;
                button.disabled = false;
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.innerHTML = `<div class="alert alert-danger" role="alert">Error: ${error.message}</div>`;
                console.error('Error:', error);
            });
        }

        // Función auxiliar para obtener el token CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}

{% endblock %}
